<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess dev</title>
</head>

<body >
    <style>
        html,body
        {
            padding:0;
            margin:0;
            background-color: rgba(61, 66, 75, 0.856);
        }
        canvas
        {
            border-radius: 5px;
            
        }
        .draggable
        {
            position:absolute;
            border-radius: 30px;
            filter: drop-shadow(0px 0px 10px rgba(0,0,0,50));
            width: 80px;
            height: 80px;
            transition-property: width,height,left,top,filter;
            transition-duration: 0.8s;
            
            user-select: none;
            -moz-user-select: none;
            -webkit-user-drag: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        #chessBoard
        {
            position: relative;
            opacity: 1;
            color: black;
            width:100%;
            height:100%;
        }
    </style>
    <script>
        const shadow="rgba(0,0,0,50)";
        const BOARD=new Array(8);
        for(let k=0;k<8;k++)
        {
            BOARD[k]=new Array(8);
            BOARD[k].fill(null);
        }
        
        var addDraggability=function(div)
        {
            var x,y;
            div.onmouseenter=function()
            {
                div.style.width="85px";
                div.style.height="85px";
                div.style.filter=`drop-shadow(${(div.homeX-320)/32}px ${(div.homeY-320)/32}px 10px ${shadow})`;
            };
            div.onmouseleave=function()
            {
                div.style.width="80px";
                div.style.height="80px";
                div.style.filter=`drop-shadow(0px 0px 10px ${shadow})`;
            };
            div.drag=function(e)
            {
                var xy=getXY(e);
                div.style.left=xy.x-x+"px";
                div.style.top=xy.y-y+"px";
                div.style.filter=`drop-shadow(${(xy.x-320)/32}px ${(xy.y-320)/32}px 10px ${shadow})`;
                //console.log(div.id)
            }
            let md=function(e)
            {
                if(!div.alive)
                return;
                var xy=getXY(e);
                //div.style.width=100+"px";
                //div.style.height=100+"px";
                div.style.zIndex="2";
                x=Number(xy.x-div.getBoundingClientRect().left);
                y=Number(xy.y-div.getBoundingClientRect().top);
                if(div.alive)
                document.addEventListener("mousemove",div.drag)
                document.addEventListener("touchmove",div.drag)
                div.style.width="100px";
                div.style.height="100px";
                div.style.transitionProperty="width,height";
            };
            div.addEventListener("mousedown",md)
            div.addEventListener("touchstart",md)
            let mu=function(e)
            {
                div.style.zIndex="1";
                div.style.width=80+"px";
                div.style.height=80+"px";
                div.style.transitionProperty='';
                document.removeEventListener("mousemove",div.drag)
                document.removeEventListener("touchmove",div.drag)
                //console.log(e.type)
                var xy=getXY(e);
                let vx=xy.x-xy.x%80;
                let vy=xy.y-xy.y%80;
                if(!(vx>=640 ||  vy>=640))
                {
                    var already=BOARD[vx/80][vy/80];
                    if(already==null)
                    {
                        //do it in a function which can handle the situation
                        //when index is out of bounds so that dead pieces 
                        //can be dealt with,as they are out of bounds
                        BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=null;
                        div.homeX=vx;
                        div.homeY=vy;
                        BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=div;
                    }
                    else
                    {
                        if(!(already.team==div.team))
                        {
                            let dead=getDeadLocation();
                            already.homeX=dead.x;
                            already.homeY=dead.y;
                            already.alive=false;
                            already.onmouseenter=null;
                            already.onmouseleave=null;
                            //console.log(already);
                            //use mutation observer
                            already.style.left=already.homeX+"px";
                            already.style.top=already.homeY+"px";
                            //repitition
                            BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=null;
                            div.homeX=vx;
                            div.homeY=vy;
                            BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=div;
                        }
                    }
                }
                
                div.style.left=div.homeX+"px";
                div.style.top=div.homeY+"px";
            };
            div.addEventListener("mouseup",mu)
            div.addEventListener("touchend",mu)
            div.addEventListener("touchcancel",mu)
            document.addEventListener("mouseup",function(e)
            {
                document.removeEventListener("mousemove",div.drag)
                document.removeEventListener("touchmove",div.drag)
                
            })
        }
        var cx=0;cy=0;
        var face=["br","bn","bb","bq","bk","bb","bn","br","bp","bp","bp","bp","bp","bp","bp","bp",
                    "wp","wp","wp","wp","wp","wp","wp","wp","wr","wn","wb","wk","wq","wb","wn","wr"];
        var board=document.createElement("div");
        var squares=document.createElement("canvas");
        squares.width=640;
        squares.height=640;
        board.appendChild(squares);
        var g=squares.getContext('2d');
        var painter=function()
        {
            g.clearRect(0,0,squares.width,squares.height);
            let black=false;
            for(let i=0;i<640;i+=80)
            {
                for(let j=0;j<640;j+=80)
                {
                    if(black)
                    {
                        
                        g.fillStyle="#9e5135";
                    }
                    else
                    {
                        g.fillStyle="#fbe9c9";
                    }
                    black=!black;
                    g.fillRect(i,j,80,80);
                }
                black=!black;
            }
            //window.requestAnimationFrame(painter);
        }
        window.requestAnimationFrame(painter);
        board.className="#chessBoard";
       document.body.appendChild(board);
        for(let i=0;i<face.length;i++)
        {
            var go=document.createElement("img");
            go.id=face[i];
            go.team=go.id.charAt(0);
            go.className="draggable";
            go.src="Fantasy/"+face[i]+".png";
            board.appendChild(go);
            go.homeX=cx;
            go.homeY=cy;
            go.alive=true;
            BOARD[go.homeX/80][go.homeY/80]=go;
            cx+=80;
            if(cx==640)
            {
                cx=0;
                cy+=80;
            }
            if(cy==160  )
            {
                cy=480;

            }
            go.style.left=go.homeX+"px";
            go.style.top=go.homeY+"px";
            addDraggability(go);
            
        }
        
        
    </script>
    <script>
        let x=0,y=-80;
        let offsetX=Number(window.innerWidth<750?0:720);
        let offsetY=Number(window.innerHeight>800?640:0);
        //console.log(offsetX,offsetY)
        function getDeadLocation()
        {
            y+=80;
            if(y==640)
            {
                y=0;
                x+=80;
            }
            let q=x+offsetX,w=y+offsetY;
            return {"x":q,"y":w};
        }

        function getXY(e)
        {
            if(e.type.substring(0,5)=="touch")
            {
                let evt=(typeof e.originalEvent==='undefined')?e:e.originalEvent;
                let touch=evt.touches[0]||evt.changedTouches[0];
                return {"x":touch.pageX,"y":touch.pageY};
            }
            else if(e.type.substring(0,5)=="mouse")
            {
                return {"x":e.clientX,"y":e.clientY};
            }
        }
    </script>
</body>
</html>