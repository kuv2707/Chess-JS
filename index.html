<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0000AA">
    <title>Chess dev</title>
</head>

<body >
    <style>
        @font-face 
        {
            font-family: defFont;
            src: url(PAPYRUS.TTF);
        }
        html,body
        {
            padding:0;
            margin:0;
            min-height:100%;
            width:100%;
            overflow: hidden;
            transition-property: background;
            -webkit-user-select: none;
            user-select: none;
        }
        *
        {
            border: none;
            transform-origin: center;
            
        }
        canvas
        {
            border-radius: 20px;
            
        }
        #colorSelector
        {
            position: absolute;
            width:100px;
            height:70px;
            border-radius: 30px;
            background-color: #5ab9c1;
            border:none;
            filter:drop-shadow(0px 0px 30px black);
            text-align: center;
            font-size: 50px;
            top:20px;
            transition-duration: 0.8s;
            transition-property: left;
            
        }
        label
        {
            position: absolute;
            width:100px;
            height:70px;
            border-radius: 100px;
            
            background-color: #000000;
            filter:drop-shadow(0px 0px 30px rgb(4, 4, 4));
            
            box-shadow: 0 0 20px white ;
            text-align: center;
            font-size: 50px;
            transition-duration: 0.8s;
            transition-property: color,left,border-radius,background-color;
            font-family: defFont;
            
        }
        
        .draggable
        {
            position:absolute;
            
            width: 80px;
            height: 80px;
            transition-property: width,height,left,top,filter;
            transition-duration: 0.8s;
            
            user-select: none;
            -moz-user-select: none;
            -webkit-user-drag: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        #chessBoard
        {
            position:absolute;
            filter:drop-shadow(0px 0px 40px black);
            top:25px;
            display: grid;
            transition-duration: 0.8s;
            transition-property: left;
            
            grid-template-columns: repeat(8,80px);
            grid-template-rows: repeat(8,80px);
        }
        .boardSquares
        {
            width:80px;
            height:80px;
            border-radius: 0px;
            border:none;
            transition-duration: 0.5s;
        }
        #container
        {
            transition-duration: 0s;
        }
    </style>
    <script id="GlobalVariables">
        var turn=false;
        var blackSquares="#6E1111";
        var whiteSquares="#ffa1a1";
        var boardOffsetX=(window.innerWidth/window.innerHeight>1)?window.innerWidth/2-320:0;
        const boardOffsetY=25;
        const Pieces=new Array();
        var activeShadow="#d1dfe5";
        var inactiveShadow="black";
        /*

            mode should represent whether the device is capable of handling many animations
        */
        const mode=window.innerWidth/window.innerHeight>1;
        var labelInactive="black";
        var labelActive="white"
        if(mode)
        {
            
        }
        else
        {
            activeShadow="black";
        }
    </script>
    <script id="GUI">
        
        let switchTurn;
        if(mode)
        {
            
            switchTurn=function()
            {
                turn=!turn;
                let deg;
                if(turn)
                deg=0;
                else
                deg=180;
                
                labelW.style.color=labelActive;
                labelB.style.color=labelInactive;
                
                board.style.transform=`rotate(${deg}deg)`;
                labelB.style.transform=`rotate(${deg}deg)`;
                labelW.style.transform=`rotate(${deg}deg)`;
                for(let i=0;i<Pieces.length;i++)
                {
                    
                    if(!Pieces[i].alive)
                    continue;
                    Pieces[i].style.transform=`rotate(${deg}deg)`;
                    if(Pieces[i].team!=turn)
                    Pieces[i].style.filter=`drop-shadow(0 0 10px ${inactiveShadow})`;
                    else
                    Pieces[i].style.filter=`drop-shadow(0 0 10px ${activeShadow})`;
                }
            }
        }
        else
        {
            activeShadow="black";
            
            for(let i=0;i<Pieces.length;i++)
            {
                Pieces[i].style.filter=`drop-shadow(0px 0px 10px ${inactiveShadow})`;
            }
            switchTurn=function()
            {
                turn=!turn;
                if(turn)
                {
                    labelW.style.color=labelActive;
                    labelB.style.color=labelInactive;
                    for(let i=0;i<Pieces.length;i++)
                    Pieces[i].style.transform="rotate(0deg)";
                }
                else
                {
                    labelB.style.color=labelActive;
                    labelW.style.color=labelInactive;
                    for(let i=0;i<Pieces.length;i++)
                    Pieces[i].style.transform="rotate(180deg)";
                }
            }
        } 
        const BOARD=new Array(8);
        for(let k=0;k<8;k++)
        {
            BOARD[k]=new Array(8);
            BOARD[k].fill(null);
        }
        
        
        var board=document.createElement("div");
        var chessBoard=document.createElement("div");
        chessBoard.id="chessBoard";
        let sqs=new Array();
        for(let i=0;i<8;i++)
        {
            let arr=new Array();
            for(let j=0;j<8;j++)
            {
                let sq=document.createElement("div");
                if(mode)
                sq.style.transitionProperty="background-color";
                sq.className="boardSquares";
                sq.id="square"+i+"_"+j;
                if((i+j)%2==0)
                {
                    sq.style.backgroundColor=blackSquares;
                    sq.revert=function()
                    {
                        this.style.backgroundColor=blackSquares;
                    }
                }
                else
                {
                    sq.style.backgroundColor=whiteSquares;
                    sq.revert=function()
                    {
                        this.style.backgroundColor=whiteSquares;
                    }
                    
                }
                chessBoard.append(sq);
                arr.push(sq);
            }
            sqs.push(arr);
        }
        let blood=document.createElement("img");
        
        blood.style=
        `position:absolute;
        z-index=2;
        width:80px;
        height:80px;
        `;
        
        chessBoard.refresh=function()
        {
            sqs.forEach(function(k,i)
            {
                k.forEach(function(l,j)
                {
                    
                    if((i+j)%2==0)
                    {
                        l.style.backgroundColor=blackSquares;
                        
                    }
                    else
                    {
                        l.style.backgroundColor=whiteSquares;
                        
                    }
                })
            })
            
        }
        chessBoard.width=640;
        chessBoard.height=640;
        chessBoard.style.left=window.innerWidth/2-320+"px";
        board.appendChild(chessBoard);
        
        
        
        board.className="#container";
        if(mode)
        {
            board.style=`
            width:100vw;
            height:100vh;
            position:relative;
            transform-origin: 50vw 50vh;
            transition-duration: 0s;
            transition-property: transform;
            `;
        }
        document.body.appendChild(board);

        
        var colorSelector=document.createElement("input");
        colorSelector.id="colorSelector";
        colorSelector.type="color";
        colorSelector.style.left=window.innerWidth/2+420+30+"px";
        colorSelector.style.top=window.innerHeight-120+"px";
        colorSelector.value=whiteSquares;
        colorSelector.innerHTML="Color";
        board.appendChild(colorSelector);
        
        
        var labelW=document.createElement("label");
        labelW.style.left=window.innerWidth/2+320+30+"px";
        labelW.style.top="100px";
        labelW.style.width="300px";
        labelW.innerHTML="White";
        labelW.style.color="black";

        var labelB=document.createElement("label");
        labelB.style.left=window.innerWidth/2-320-330+"px";
        labelB.style.top="100px";
        labelB.style.width="300px";
        labelB.innerHTML="Black";

        
        
        board.appendChild(labelW);
        board.appendChild(labelB);
        
        
        
    </script>
    <script id="landsc_portrait">
        let xb=-330;
        let yb=220;
        let xw=0;
        let yw=220;
        var allotDeadLocation;
        if(window.innerWidth/window.innerHeight>1)
        {
            //landscape view
            labelB.style.textShadow=`            
                0 0 7px #fff,
                0 0 10px #fff, 
                0 0 21px #fff, 
                0 0 42px #0af, 
                0 0 82px #0af, 
                0 0 92px #0af, 
                0 0 102px #0af,
                0 0 151px #0af`;
            labelW.style.textShadow=`            
                0 0 7px #fff,
                0 0 10px #fff, 
                0 0 21px #fff, 
                0 0 42px #0fa, 
                0 0 82px #0fa, 
                0 0 92px #0fa, 
                0 0 102px #0fa,
                0 0 151px #0fa`;
                var sync;
            colorSelector.addEventListener("focus", function (e) 
            {
                sync=setInterval(function()
                    {
                        setTheme(createTheme(HexToRGB(e.target.value)));
                        
                    },5);
                
            });
            colorSelector.addEventListener("blur", function () 
            {
                clearInterval(sync);
            });
            
            window.addEventListener("resize",function()
            {
                chessBoard.style.left=window.innerWidth/2-320+"px";
                boardOffsetX=window.innerWidth/2-320;
                colorSelector.style.left=window.innerWidth/2+420+30+"px";
                colorSelector.style.top=window.innerHeight-120+"px";
                labelW.style.left=window.innerWidth/2+320+30+"px";
                labelB.style.left=window.innerWidth/2-320-330+"px";
                
                Pieces.forEach(function(dog)
                {
                    if(dog.alive)
                    dog.style.left=dog.homeX+boardOffsetX+"px";
                    else
                    {
                        if(dog.team==false)
                        dog.style.left=window.innerWidth/2-320+dog.homeX+"px";
                        else
                        dog.style.left=window.innerWidth/2+320+dog.homeX+"px";
                    }
                });
            });

            sqs.forEach(function(k,i)
            {
                k.forEach(function(l,j)
                {
                    
                    l.style.borderRadius="15px";
                })
            })
            
            allotDeadLocation=function(piece)
            {
                if(piece.team==false)
                {
                    
                    piece.style.left=window.innerWidth/2-320+xb+"px";
                    piece.style.top=yb+boardOffsetY+"px";
                    piece.style.height="75px";
                    piece.style.width="75px";
                    piece.homeX=xb;
                    piece.homeY=yb;
                    xb+=75;
                    if(xb==-30)
                    {
                        xb=-330;
                        yb+=75;
                    }
                    
                }
                else
                {
                    piece.style.left=window.innerWidth/2+330+xw+"px";
                    piece.style.top=yw+boardOffsetY+"px";
                    piece.style.height="75px";
                    piece.style.width="75px";
                    piece.homeX=xw+10;
                    piece.homeY=yw;
                    xw+=75;
                    if(xw==300)
                    {
                        xw=0;
                        yw+=75;
                    }
                }
                
                
            };

        }
        else
        {
            //portrait view
            labelB.style.textShadow=`            
                0 0 7px #fff,
                0 0 10px #fff, 
                0 0 21px #fff, 
                0 0 42px #0af, 
                0 0 82px #0af 
                `;
            labelW.style.textShadow=`            
                0 0 7px #fff,
                0 0 10px #fff, 
                0 0 21px #fff, 
                0 0 42px #0fa, 
                0 0 82px #0fa
                `;
            colorSelector.addEventListener("change", function (e) 
            {
                setTheme(createTheme(HexToRGB(e.target.value)));
                
            });
            chessBoard.style.left="0px";
            Pieces.forEach(function(dog)
            {
                if(dog.alive)
                dog.style.left=dog.homeX+boardOffsetX+"px";
                else
                {
                    if(dog.team==false)
                    dog.style.left=window.innerWidth/2-320+dog.homeX+"px";
                    else
                    dog.style.left=window.innerWidth/2+320+dog.homeX+"px";
                }
            });
            boardOffsetX=0;
            colorSelector.style.left="270px";
            colorSelector.style.top="760px";
            labelW.style.left="330px";
            labelB.style.left="10px";
            labelW.style.top="680px";
            labelB.style.top="680px";

            xb=0;
            xw=320;
            yb=840;
            yw=840;

            
            
            allotDeadLocation=function(piece)
            {
                if(piece.team==false)
                {
                    
                    piece.style.left=xb+"px";
                    piece.style.top=yb+boardOffsetY+"px";
                    piece.style.height="75px";
                    piece.style.width="75px";
                    piece.homeX=xb;
                    piece.homeY=yb;
                    xb+=60;
                    if(xb==240)
                    {
                        xb=0;
                        yb+=60;
                    }
                    
                }
                else
                {
                    piece.style.left=xw+"px";
                    piece.style.top=yw+boardOffsetY+"px";
                    piece.style.height="75px";
                    piece.style.width="75px";
                    piece.homeX=xw;
                    piece.homeY=yw;
                    xw+=60;
                    
                    if(xw==320+240)
                    {
                        xw=320;
                        yw+=60;
                    }
                }
                
                
            }
        }

        function getXY(e,transforms)
        {
            let x=0,y=0;
            if(!mode)
            transforms=false;
            if(e.type.substring(0,5)=="touch")
            {
                let evt=(typeof e.originalEvent==='undefined')?e:e.originalEvent;
                let touch=evt.touches[0]||evt.changedTouches[0];
                x=touch.pageX;
                y=touch.pageY;
                
            }
            if(e.type.substring(0,5)=="mouse")
            {
                x=e.clientX;
                y=e.clientY;
            }
            if(transforms)
            {
                if(turn)
                {
                    return {"x":x,"y":y};
                }
                else
                {
                    return rotate({"x":x,"y":y});
                }
            }
            else
            {
                return {"x":x,"y":y};
            }
        }
        function rotate({x,y})
        {
            return{"x":window.innerWidth-x,
                "y":window.innerHeight-y}
        }
        let play=0;
        let playstart=function()
        {
            clearInterval(play);
            play=setInterval(function()
            {
                let temp=Pieces[Math.floor(Math.random()*Pieces.length)].style;
                temp.left=Math.floor(Math.random()*560/80)*80+boardOffsetX+"px";
                temp.top=Math.floor(Math.random()*560/80)*80+boardOffsetY+"px";
            },50);
        }
        let playend=function()
        {
            clearInterval(play);
            for(let i=0;i<Pieces.length;i++)
            {
                Pieces[i].style.top=Pieces[i].homeY+boardOffsetY+"px";
                Pieces[i].style.left=Pieces[i].homeX+boardOffsetX+"px";
            }
            window.dispatchEvent(new Event('resize'));
        }
        labelB.addEventListener("touchstart",playstart);
        labelB.addEventListener("click",playstart);
        labelW.addEventListener("touchstart",playend);
        labelW.addEventListener("click",playend);
        
    </script>
    <script id="driver code">
        const tentativeMove=
        {
            x:0,
            y:0,
            listen:false,
            kill:false,
            prev:null,
            prevCol:null,
            color:"#2ae7a2",
            setXY:function(x,y)
            {
                if(!this.listen)
                return;
                if(this.x==x  &&  this.y==y)
                return;
                this.x=x;
                this.y=y;
                if(this.prev)
                this.prev.revert()
                this.prev=sqs[y][x];
                if(BOARD[x][y]==null)
                {
                    this.color="#2ae7a2";
                }
                else
                {
                    this.color="red";
                }
                this.prev.style.backgroundColor=this.color;
            },
            setListen:function(yes)
            {
                this.listen=yes;
                if(!yes)
                {
                    this.prev.revert();
                }
            }
        }
        var addDraggability=function(div)
        {
            var x,y;
            //only for pointer-based devices
            div.onmouseenter=function()
            {
                if(turn!=div.team)
                return;
                div.style.width="85px";
                div.style.height="85px";
                div.style.filter=`drop-shadow(0 0 20px ${activeShadow})`;
            };
            div.onmouseleave=function()
            {
                div.style.width="80px";
                div.style.height="80px";
                div.style.filter=`drop-shadow(0 0 10px ${turn==div.team&&mode==true?activeShadow:inactiveShadow})`;
            };
            div.drag=function(e)
            {
                e.stopPropagation();
                e.preventDefault();
                div.style.transitionProperty="width,height";
                var xy=getXY(e,true);
                div.style.left=xy.x-x+"px";
                div.style.top=xy.y-y+"px";
                div.style.filter=`drop-shadow(0 0 15px ${activeShadow})`;
                
                let a=Math.floor(tentativeMove.x);
                let b=Math.floor(tentativeMove.y);
                tentativeMove.setXY(Math.floor((xy.x-boardOffsetX)/80),
                Math.floor((xy.y-boardOffsetY)/80));
            }
            let md=function(e)
            {
                if(!div.alive)
                return;
                if(turn!=div.team)
                return;
                var xy=getXY(e,false);
                div.style.zIndex="3";
                x=Number(xy.x-div.getBoundingClientRect().left);
                y=Number(xy.y-div.getBoundingClientRect().top);
                if(mode  &&  !turn)
                {
                    x=80-x;
                    y=80-y;
                }
                
                if(div.alive)
                {
                    document.addEventListener("mousemove",div.drag)
                    document.addEventListener("touchmove",div.drag)
                }
                div.style.width="100px";
                div.style.height="100px";
                document.addEventListener("mouseup",docmu)
                document.addEventListener("touchend",docmu)
                tentativeMove.setListen(true);
            };
            div.addEventListener("mousedown",md)
            div.addEventListener("touchstart",md)
            let mu=function(e)
            {
                if(!div.alive)
                return;
                var xy=getXY(e,true);
                setTimeout(()=>div.style.zIndex="1",850);
                
                div.style.width=80+"px";
                div.style.height=80+"px";
                div.style.transitionProperty=div.defaulttp;
                document.removeEventListener("mousemove",div.drag)
                document.removeEventListener("touchmove",div.drag)
                let vx=Math.floor((xy.x-boardOffsetX)/80)*80;
                let vy=Math.floor((xy.y-boardOffsetY)/80)*80;
                
                if(!(vx>=640 ||  vy>=640  ||  vx<0  ||  vy<0))
                {
                    /**
                     * a successful turn is when:
                     * already is null
                     * or it is of different team
                     */
                    var already=BOARD[vx/80][vy/80];//indexoutofbounds exception never occurs
                    if(already==null)
                    {
                        switchTurn();
                        
                        BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=null;
                        div.homeX=vx;
                        div.homeY=vy;
                        BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=div;
                    }
                    else
                    {
                        if(!(already.team==div.team))
                        {
                            //kill what is already there
                            let hx=already.homeX;
                            let hy=already.homeY;
                            allotDeadLocation(already);
                            already.alive=false;
                            blood.src="blood"+ ( Math.random()<0.5?"1":"2")  +".png";//add another image for blood
                            blood.style.left=hx+"px";
                            blood.style.top=hy+"px";
                            blood.remove();
                            sqs[vy/80][vx/80].append(blood);
                            already.onmouseenter=null;
                            already.onmouseleave=null;
                            switchTurn();
                            already.style.filter=`drop-shadow(0px 0px 10px black)`;
                            
                            //repitition
                            BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=null;
                            div.homeX=vx;
                            div.homeY=vy;
                            BOARD[Math.floor(div.homeX/80)][Math.floor(div.homeY/80)]=div;
                        }
                        
                    }
                }
                
                div.style.left=div.homeX+boardOffsetX+"px";
                div.style.top=div.homeY+boardOffsetY+"px";
            };
            let docmu=function(e)
            {
                document.removeEventListener("mousemove",div.drag)
                document.removeEventListener("touchmove",div.drag)
                document.removeEventListener("mouseup",docmu)
                document.removeEventListener("touchend",docmu)
                mu(e);
                tentativeMove.setListen(false);
            };
            
        }
        var cx=0;cy=0;
        var face=["br","bn","bb","bq","bk","bb","bn","br","bp","bp","bp","bp","bp","bp","bp","bp",
                  "wp","wp","wp","wp","wp","wp","wp","wp","wr","wn","wb","wk","wq","wb","wn","wr"];
        for(let i=0;i<face.length;i++)
        {
            var go=document.createElement("img");
            go.id=face[i];
            go.team=go.id.charAt(0)=='b'?false:true;//false means black
            go.className="draggable";
            go.src="Fantasy/"+face[i]+".png";
            go.alt=face[i];
            board.appendChild(go);
            go.homeX=cx;
            go.homeY=cy;
            go.alive=true;
            
            BOARD[go.homeX/80][go.homeY/80]=go;
            cx+=80;
            if(cx==640)
            {
                cx=0;
                cy+=80;
            }
            if(cy==160  )
            {
                cy=480;

            }
            go.style.left=go.homeX+boardOffsetX+"px";
            go.style.top=go.homeY+boardOffsetY+"px";
            if(mode)
            {
                go.style.transitionProperty="width,height,left,top,filter,transform";
                go.defaulttp="width,height,left,top,filter,transform";
            }
            else
            {
                go.style.transitionProperty="width,height,left,top,filter";
                go.defaulttp="width,height,left,top,filter";
            }
            addDraggability(go);
            //go.style.filter=`drop-shadow(0 0 10px ${activeShadow})`;
            Pieces.push(go);

        }
        switchTurn();
    </script>
    <script id="theme">
        const setTheme=function(theme)
        {
    theme.chromeTheme=theme.bs;
            whiteSquares=theme.ws;
            blackSquares=theme.bs;
            document.querySelector('meta[name="theme-color"]').setAttribute('content', theme.chromeTheme);
            colorSelector.style.backgroundColor=theme.elems;
            labelW.style.backgroundColor=theme.elems;
            labelB.style.backgroundColor=theme.elems;
            let sty=document.body.style;
            sty.background=`linear-gradient(180deg,${theme.grad1},${theme.grad2},${theme.grad3})`;
            sty.backgroundRepeat="no-repeat"
            sty.backgroundAttachment="fixed";
            chessBoard.refresh();
            activeShadow="#d1dfe5"
            if(theme.baseColor.red+theme.baseColor.red+theme.baseColor.red>320)
            {
                labelActive=getPercentColor(theme.baseColor,7);
            }
            else
            {
                labelActive="white";
            }
        }
        
        function createTheme({red,green,blue,alfa})
        {
            var bs=getPercentColor({red,green,blue},60);
            var ws=getPercentColor({red,green,blue},140);
            var grad1=getPercentColor({red,green,blue},5);
            var grad2=getPercentColor({red,green,blue},40);
            var grad3=getPercentColor({red,green,blue},100);
            var elems=getPercentColor({red,green,blue},100);
            return{
                bs,ws,grad1,grad2,grad3,elems,baseColor:{red,green,blue,alfa}
            };
        }
        function getPercentColor({red,green,blue},percent)
        {
            var red=red*percent/100;
            red=red>255?255:red;
            var green=green*percent/100;
            green=green>255?255:green;
            var blue=blue*percent/100;
            blue=blue>255?255:blue;
            return `rgb(${red} ${green} ${blue})`;
        }
        setTheme(createTheme({red:57,green:155,blue:162}));

        colorSelector.value="#399BA2";
        function HexToRGB(hexcol)
        {
            return{
                red:parseInt(hexcol.substring(1,3),16),
                green:parseInt(hexcol.substring(3,5),16),
                blue:parseInt(hexcol.substring(5,7),16)
            }
        }
    </script>
</body>
</html>
